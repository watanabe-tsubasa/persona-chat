## リファクタリング方針（保守性・安全性・可読性の向上）

本ドキュメントは、既存機能・テスト・Biome のルールを維持したまま、中長期の保守性を高めるためのリファクタリング方針と段階的マイルストーンを定義します。

### 目的
- 可読性: 責務分離と命名の一貫性で読み解きやすくする
- 安全性: 型・スキーマ・環境変数の検証を徹底し不具合を早期に発見
- 拡張性: 機能追加時に既存コードへの影響を局所化
- 観測性: 失敗時の原因特定を容易にするログ/エラー標準化

---

### 全体方針
- 責務分離: API ルートは I/O と組み立てのみに集中。ドメインロジックは `lib/` 下に移譲
- 明確な境界: 「スキーマ/型」「サービス」「リポジトリ」「LLM ユーティリティ」「環境変数/設定」を層で分離
- 入出力のスキーマ化: Zod で API入力・DB 行・LLM 出力 JSON を検証
- エラーの標準化: 返却フォーマット `{ error: { code, message } }` とし、ログは構造化
- 変更は小さく段階的に: 動く状態を保ちながらマイルストーンごとに反映（テスト緑を維持）

---

### 優先度の高いリファクタリング項目

1) モジュール構成と責務分離（lib 配下の再編）
- 追加予定ディレクトリ:
  - `lib/schemas`: API リクエスト/レスポンス、DB 行、LLM 応答の Zod スキーマと型
  - `lib/services`: ユースケース単位のドメインサービス（例: `personaService.ts`）
  - `lib/repositories`: データアクセス層（例: `personaRepository.ts`）
  - `lib/llm`: LLM 呼び出し周りの共通処理（JSON サニタイズ、プロンプト定義）
  - `lib/utils`: 文字列・メッセージ整形、共通ヘルパー
- API ルート（`app/api/*/route.ts`）は「入出力のバリデーション」「サービス呼び出し」「HTTP 化」のみへ集約

2) 型と API/DB/LLM I/O のスキーマ化
- `/api/personas` POST body（`{ userId, name, logs }`）を Zod で検証（サイズ/長さの上限含む）
- `/api/chat` の messages と `personaId` を Zod で検証。`parts` から文字列化するユーティリティを共通化
- Persona 行（`id, name, persona_prompt, examples`）を Zod で型付け（将来的には `examples` を JSON 配列化も検討）
- `lib/persona.ts` の LLM 出力 JSON を Zod で安全にパース（Fence 無視・フォールバック）

3) 環境変数の型安全化と起動時検証
- `lib/env.server.ts` を追加し Zod で `OPENAI_API_KEY`, `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` を検証
- 不足や空文字はサーバ起動時に fail fast（現在の空文字代入を廃止）

4) エラーハンドリング/ロギングの標準化
- `lib/logger.ts` を追加し `LOG_LEVEL` に応じた構造化ログ（edge でも動作）
- API エラーは `{ error: { code, message } }` で統一、例外を握り潰さずメタ情報を残す

5) サービス/リポジトリ層の導入
- Supabase 直接呼び出しを `personaRepository` に集約（取得・追加・変換責務を集約）
- `personaService` で「ログからプロンプト生成 → 固定例生成 → 永続化」のワークフローを統合

6) LLM 連携の共通化（lib/llm）
- JSON フェンス除去と安全パースのユーティリティ化（現在 `lib/persona.ts` 内の重複処理を統合）
- モデル名の集中管理・パラメータの規定値化（温度・トークン制限など）

7) クライアント（`app/page.tsx`）の軽量化
- Debug セクションを小コンポーネント化（例: `components/PersonaDebugPanel.tsx`）
- ハンドラ/状態の整理・型明示・副作用分離

8) テスト戦略の強化
- 新設スキーマ/ユーティリティ/サービス/リポジトリの単体テストを追加
- API ルートは純ロジックをサービスに押し出し、単体テストで網羅
- 既存テストは温存しつつ、エラーパスや境界値のケースを追加

9) セキュリティ/堅牢性
- 入力サイズ上限（`logs`・`name`）の明示化とバリデーション
- `service role` キーはサーバ専用であることをコメントとガードで明示（Edge 環境での取り扱いに注意）

10) DX/スタイル
- Biome の import 並び・未使用検出を維持。新規ファイルもルール適用
- 関数の戻り値型を明示、曖昧な `any` を排除

---

### リスクと対策
- Edge + Supabase Service Role: 取り扱いは API ルート内（サーバのみ）に限定。環境変数の漏洩に注意し、依存箇所を一箇所に固定
- LLM 応答の非構造化: スキーマ検証＋フォールバックテキストを定義し、常に安全な出力を返す
- 段階的移行中の挙動差分: マイルストーンごとに小さな PR/コミットで反映し、テストを常時グリーンに保つ

---

### 実施ステップ（マイルストーン）

M1: 下地づくり（構造・ユーティリティの追加）
- [x] `lib/schemas`, `lib/llm`, `lib/utils` を追加（Zod スキーマ、LLM JSON パース、メッセージ整形）
- [x] `lib/env-openai.server.ts`, `lib/env-supabase.server.ts`, `lib/logger.ts` を追加（起動時検証/ロガー）
- [x] 既存コードに影響しない形でユーティリティ実装・適用

M2: 入出力のスキーマ化
- [x] `/api/personas` POST body と `/api/chat` body の Zod スキーマを作成
- [x] DB 行（persona）のスキーマ化と型エクスポート
- [x] 既存ルートにスキーマバリデーションを追加（エラーレスポンス標準化）

M3: LLM レイヤーの共通化
- [x] `lib/persona.ts` の JSON パース/フェンス除去処理を `lib/llm` に移譲
- [x] モデル設定とパラメータの集中管理（`lib/llm/models.ts` を導入・適用）
- [x] 既存テストと互換を維持（LLM 出力の安全パースを強化）

M4: リポジトリ/サービス導入
- [x] `domains/personas/repositories/personaRepository.ts` を導入
- [x] `domains/personas/services/personaService.ts` を導入
- [x] API ルート（`/api/personas`, `/api/chat`, `/api/getpersona`）からドメインロジックを排出

M5: クライアント整理
- [x] Debug UI を小コンポーネントへ分離（`app/components/PersonaDebugPanel.tsx`）
- [x] フォームハンドラの型・副作用の整理（`useCallback` 化、trim 処理）

M6: ロギング/エラー標準化
- [x] すべての API ルートを `{ error: { code, message } }` へ統一
- [x] 構造化ログを導入し、機密値を記録しない

M7: 仕上げ
- [x] 進捗ドキュメント更新（本ファイル）
- [x] テストケース拡充（境界値・エラーパス）とカバレッジ確認（レポート生成は環境制約下）

---

## 現在の進捗サマリ（2025-09-01）

- 実装済み: M1, M2, M3（モデル集中管理の導入も完了）, M4, M5（Debug UI 分離・フォーム整理）、M6（統一エラー/ロガー）、各ファイルにヘッダーコメント追加
- 追加対応: モデル設定・温度の集中管理（`lib/llm/models.ts`）を導入し、`lib/persona.ts` と `/api/chat` に適用
- 型の単一情報源化: `lib/schemas` から `z.infer` 型を輸出し、`lib/utils/messages.ts`/`app/components/PersonaDebugPanel.tsx` などで参照
- 未実施/着手予定: M7 の追加テスト拡充
- Lint/Format: すべてパス（Biome）
- テスト: 既存テストは緑（実行環境の終了時警告を除く）。機能回帰なし

---

## 次のステップ（着手予定）

1) M7: 重要パスの追加テスト（スキーマ失敗時エラー、サービス/リポジトリの異常系）とカバレッジ確認

---

### 受け入れ基準（Definition of Done）
- すべてのテストと Biome lint がパス
- API のリクエスト/レスポンスが Zod で検証される
- `lib/persona.ts` のパース処理が `lib/llm` の共通関数経由
- Supabase へのアクセスが `personaRepository` に集約
- API ルートのロジックが薄く、サービス/スキーマへの依存が明確
- エラー応答の形式が統一され、ログが過不足なく記録

---

### 変更の影響とコミュニケーション
- 破壊的変更は避ける前提。`examples` の DB 形式変更（文字列→JSON 配列）は将来検討（今回は見送り）
- 外部 API/依存の追加は無し（Zod のみ追加する場合は別途合意）
- PR はマイルストーン単位で小さく提出し、レビュー負荷を最小化

---

### 具体的タスク一覧（チェックリスト）
- [x] 環境変数検証（fail fast）: `lib/env-openai.server.ts` / `lib/env-supabase.server.ts`
- [x] 構造化ログ（edge 互換）: `lib/logger.ts`
- [x] フェンス除去・安全パース: `lib/llm/json.ts`
- [x] メッセージ整形: `lib/utils/messages.ts`
- [x] Chat リクエスト Zod: `lib/schemas/chat.ts`
- [x] Persona 行/POST body Zod: `lib/schemas/persona.ts`
- [x] リポジトリ集約: `domains/personas/repositories/personaRepository.ts`
- [x] サービス導入: `domains/personas/services/personaService.ts`
- [x] API ルートのバリデーション/サービス呼出へ置換
- [x] クライアント Debug パネルの分離
- [x] テスト追加（スキーマ/ユーティリティ/サービス/リポジトリ）
- [x] ドキュメント更新（progress.md）

備考: 現在の仕様（Edge ランタイム、Service Role の利用、`examples` 文字列保存、60k 文字上限トリム）には手を入れず、安全性と構造化を先行させます。
